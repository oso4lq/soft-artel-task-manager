<!-- main-page.component.html -->

<!-- DESKTOP UI -->
<ng-template #desktopView>
    <!-- Current date -->
    <h1 class="main-date">
        {{ currentDateStr() }}
    </h1>

    <!-- Dropdown menu filters -->
    <div class="dropdown-filters flex-row">

        <p-dropdown class="dropdown-filters__select flex-row center-row"
            [ngClass]="{'dropdown-filters__select_active': selectedProduct() !== 'all'}" [options]="productOptions()"
            optionLabel="label" optionValue="value" [(ngModel)]="selectedProduct"
            (onChange)="onProductFilterChange($event.value)" [showClear]="false" [filter]="false" dropdownIcon="none">

            <ng-template pTemplate="item" let-prod>
                <div class="flex align-items-center">
                    <app-icon *ngIf="prod?.icon" [iconId]="prod.icon" width="16" height="16" color="#B0B0B0"></app-icon>
                    <span style="margin-left: 4px;">{{ prod.label }}</span>
                </div>
            </ng-template>

            <ng-template pTemplate="selectedItem" let-prod>
                <div class="flex align-items-center">
                    <app-icon *ngIf="prod?.value !== 'all'" [iconId]="prod?.icon" width="16" height="16"
                        color="#B0B0B0"></app-icon>
                    <span style="margin-left: 4px;">{{ prod?.label }}</span>
                </div>
            </ng-template>

            <ng-template pTemplate="dropdownicon">
                <app-icon iconId="icon-misc-chevron-down" width="16" height="16" color="#B0B0B0"></app-icon>
            </ng-template>
        </p-dropdown>

        <p-dropdown class="dropdown-filters__select flex-row center-row"
            [ngClass]="{'dropdown-filters__select_active': selectedCategory() !== 'all'}" [options]="categories"
            optionLabel="label" optionValue="value" [(ngModel)]="selectedCategory"
            (onChange)="onCategoryFilterChange($event.value)" [showClear]="false" [filter]="false" dropdownIcon="none">

            <ng-template pTemplate="item" let-category>
                <div class="flex align-items-center">
                    <app-icon [iconId]="category.icon" width="16" height="16"></app-icon>
                    <span style="margin-left: 4px;">{{ category.label }}</span>
                </div>
            </ng-template>

            <ng-template pTemplate="selectedItem" let-category>
                <div class="flex align-items-center">
                    <app-icon *ngIf="category?.value !== 'all'" [iconId]="category?.icon" width="16"
                        height="16"></app-icon>
                    <span style="margin-left: 4px;">{{ category?.label }}</span>
                </div>
            </ng-template>

            <ng-template pTemplate="dropdownicon">
                <app-icon iconId="icon-misc-chevron-down" width="16" height="16" color="#B0B0B0"></app-icon>
            </ng-template>
        </p-dropdown>
    </div>

    <!-- Task columns -->
    <div class="columns flex-row">

        <!-- Left column -->
        <div class="columns__left flex-col">

            <!-- Status filters -->
            <div class="status-filters flex-row center-row">
                <div class="status-filters__wrapper flex-row center-row">
                    <label class="status-filters__item h-100 flex-row center-row"
                        [ngClass]="{'status-filters__item_active': selectedStatusFilter() === TaskStatus.Approval}">
                        <input type="radio" name="leftColumnStatus" [value]="TaskStatus.Approval"
                            [(ngModel)]="selectedStatusFilter" />
                        На согласование: {{ approvalCount() }}
                    </label>

                    <label class="status-filters__item h-100 flex-row center-row"
                        [ngClass]="{'status-filters__item_active': selectedStatusFilter() === TaskStatus.Review}">
                        <input type="radio" name="leftColumnStatus" [value]="TaskStatus.Review"
                            [(ngModel)]="selectedStatusFilter" />
                        На ревью: {{ reviewCount() }}
                    </label>

                    <label class="status-filters__item h-100 flex-row center-row"
                        [ngClass]="{'status-filters__item_active': selectedStatusFilter() === TaskStatus.Execution}">
                        <input type="radio" name="leftColumnStatus" [value]="TaskStatus.Execution"
                            [(ngModel)]="selectedStatusFilter" />
                        Для работы: {{ executionCount() }}
                    </label>

                    <label class="status-filters__item h-100 flex-row center-row"
                        [ngClass]="{'status-filters__item_active': selectedStatusFilter() === TaskStatus.Draft}">
                        <input type="radio" name="leftColumnStatus" [value]="TaskStatus.Draft"
                            [(ngModel)]="selectedStatusFilter" />
                        Черновики: {{ draftCount() }}
                    </label>
                </div>
            </div>

            <!-- Left column -->
            <div class="columns__wrapper flex-col">

                <!-- My tasks -->
                <div class="tasks-block flex-col">
                    <div class="tasks-block__title flex-row center-row" (click)="toggleCollapsible('myTasks')">
                        <span class="collapse-icon" [ngClass]="{'collapsed': collapsed().myTasks}">
                            <app-icon iconId="icon-misc-chevron-down" width="16" height="16" color="#B0B0B0"></app-icon>
                        </span>
                        Мои: {{ myTasksFiltered().length }}
                    </div>
                    <!-- *ngIf="!collapsed.myTasks" -->
                    <div class="tasks-block__body tasks-block__body_collapsible flex-col" *ngIf="!collapsed().myTasks">
                        <!-- Check if user exists -->
                        <ng-container *ngIf="userData; else showLoginMessage">
                            <!-- Check if the user has tasks -->
                            <ng-container *ngIf="myTasksFiltered().length > 0; else showNoMyTasksMessage">
                                <app-task-card *ngFor="let t of myTasksFiltered()" [task]="t"
                                    [isInProgress]="false"></app-task-card>
                            </ng-container>
                            <!-- Message when no tasks -->
                            <ng-template #showNoMyTasksMessage>
                                <p>У вас нет задач.</p>
                            </ng-template>
                        </ng-container>
                        <!-- Message for anonymous user -->
                        <ng-template #showLoginMessage>
                            <p>Войдите в свой аккаунт, чтобы просмотреть свои задачи.</p>
                        </ng-template>
                    </div>
                </div>

                <!-- Unassigned tasks -->
                <div class="tasks-block flex-col">
                    <div class="tasks-block__title flex-row center-row" (click)="toggleCollapsible('unassigned')">
                        <span class="collapse-icon" [ngClass]="{'collapsed': collapsed().unassigned}">
                            <app-icon iconId="icon-misc-chevron-down" width="16" height="16" color="#B0B0B0"></app-icon>
                        </span>
                        Неназначенные: {{ unassignedFiltered().length }}
                    </div>
                    <!-- *ngIf="!collapsed.unassigned" -->
                    <div class="tasks-block__body tasks-block__body_collapsible flex-col"
                        *ngIf="!collapsed().unassigned">
                        <!-- Check if unassigned tasks exist -->
                        <ng-container *ngIf="unassignedFiltered().length > 0; else showNoUnassignedTasksMessage">
                            <app-task-card *ngFor="let t of unassignedFiltered()" [task]="t" [isInProgress]="false">
                            </app-task-card>
                        </ng-container>
                        <!-- Message when no tasks -->
                        <ng-template #showNoUnassignedTasksMessage>
                            <p>Нет неназначенных задач.</p>
                        </ng-template>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right column -->
        <div class="columns__right flex-col">

            <!-- In Progress tasks -->
            <div class="tasks-block tasks-block_in-progress flex-col">
                <div class="tasks-block__title tasks-block__title_in-progress">
                    В работе: {{ inProgressFiltered().length }}
                </div>
                <!-- Check if the user has tasks -->
                <ng-container *ngIf="inProgressFiltered().length > 0; else showNoInProgressTasksMessage">
                    <app-task-card *ngFor="let t of inProgressFiltered()" [task]="t" [isInProgress]="true">
                    </app-task-card>
                </ng-container>
                <!-- Message when no tasks -->
                <ng-template #showNoInProgressTasksMessage>
                    <p>Нет задач в работе.</p>
                </ng-template>
            </div>

            <!-- Paused tasks -->
            <div class="tasks-block tasks-block_paused flex-col">
                <div class="tasks-block__title">
                    На паузе: {{ pauseFiltered().length }}
                </div>
                <!-- Check if the user has tasks -->
                <ng-container *ngIf="pauseFiltered().length > 0; else showNoPausedTasksMessage">
                    <app-task-card *ngFor="let t of pauseFiltered()" [task]="t" [isInProgress]="false">
                    </app-task-card>
                </ng-container>
                <!-- Message when no tasks -->
                <ng-template #showNoPausedTasksMessage>
                    <div class="no-task-block">
                        <p>Нет задач на паузе.</p>
                    </div>
                </ng-template>
            </div>
        </div>
    </div>
</ng-template>


<!-- MOBILE UI -->
<ng-container *ngIf="(mobileService.isMobile$ | async) as isMobile; else desktopView">

    <!-- Single scrolling column -->
    <div class="single-column flex-col">

        <!-- In Progress tasks -->
        <div class="tasks-block tasks-block_in-progress flex-col">
            <div class="tasks-block__title tasks-block__title_in-progress">
                В работе: {{ inProgressFiltered().length }}
            </div>
            <ng-container *ngIf="inProgressFiltered().length > 0; else noInProgressMobile">
                <app-task-card *ngFor="let t of inProgressFiltered()" [task]="t" [isInProgress]="true"></app-task-card>
            </ng-container>
            <ng-template #noInProgressMobile>
                <p>Нет задач в работе.</p>
            </ng-template>
        </div>

        <!-- Paused tasks -->
        <div class="tasks-block flex-col">
            <div class="tasks-block__title">
                На паузе: {{ pauseFiltered().length }}
            </div>
            <ng-container *ngIf="pauseFiltered().length > 0; else noPauseMobile">
                <app-task-card *ngFor="let t of pauseFiltered()" [task]="t" [isInProgress]="false"></app-task-card>
            </ng-container>
            <ng-template #noPauseMobile>
                <p>Нет задач на паузе.</p>
            </ng-template>
        </div>

        <!-- Status filters -->
        <div class="status-filters flex-row center-row">
            <div class="status-filters__wrapper flex-row center-row">
                <label class="status-filters__item h-100 flex-row center-row"
                    [ngClass]="{'status-filters__item_active': selectedStatusFilter() === TaskStatus.Approval}">
                    <input type="radio" name="leftColumnStatus" [value]="TaskStatus.Approval"
                        [(ngModel)]="selectedStatusFilter" />
                    На согласование: {{ approvalCount() }}
                </label>

                <label class="status-filters__item h-100 flex-row center-row"
                    [ngClass]="{'status-filters__item_active': selectedStatusFilter() === TaskStatus.Review}">
                    <input type="radio" name="leftColumnStatus" [value]="TaskStatus.Review"
                        [(ngModel)]="selectedStatusFilter" />
                    На ревью: {{ reviewCount() }}
                </label>

                <label class="status-filters__item h-100 flex-row center-row"
                    [ngClass]="{'status-filters__item_active': selectedStatusFilter() === TaskStatus.Execution}">
                    <input type="radio" name="leftColumnStatus" [value]="TaskStatus.Execution"
                        [(ngModel)]="selectedStatusFilter" />
                    Для работы: {{ executionCount() }}
                </label>

                <label class="status-filters__item h-100 flex-row center-row"
                    [ngClass]="{'status-filters__item_active': selectedStatusFilter() === TaskStatus.Draft}">
                    <input type="radio" name="leftColumnStatus" [value]="TaskStatus.Draft"
                        [(ngModel)]="selectedStatusFilter" />
                    Черновики: {{ draftCount() }}
                </label>
            </div>
        </div>

        <!-- My tasks -->
        <div class="tasks-block flex-col">
            <div class="tasks-block__title flex-row center-row" (click)="toggleCollapsible('myTasks')">
                <span class="collapse-icon" [ngClass]="{'collapsed': collapsed().myTasks}">
                    <app-icon iconId="icon-misc-chevron-down" width="16" height="16" color="#B0B0B0"></app-icon>
                </span>
                Мои: {{ myTasksFiltered().length }}
            </div>
            <div class="tasks-block__body" *ngIf="!collapsed().myTasks">
                <ng-container *ngIf="userData; else showMobileLoginMessage">
                    <ng-container *ngIf="myTasksFiltered().length > 0; else noMyMobile">
                        <app-task-card *ngFor="let t of myTasksFiltered()" [task]="t"
                            [isInProgress]="false"></app-task-card>
                    </ng-container>
                    <ng-template #noMyMobile>
                        <p>У вас нет задач.</p>
                    </ng-template>
                </ng-container>
                <ng-template #showMobileLoginMessage>
                    <p>Войдите в свой аккаунт, чтобы просмотреть свои задачи.</p>
                </ng-template>
            </div>
        </div>

        <!-- Unassigned tasks -->
        <div class="tasks-block flex-col">
            <div class="tasks-block__title flex-row center-row" (click)="toggleCollapsible('unassigned')">
                <span class="collapse-icon" [ngClass]="{'collapsed': collapsed().unassigned}">
                    <app-icon iconId="icon-misc-chevron-down" width="16" height="16" color="#B0B0B0"></app-icon>
                </span>
                Неназначенные: {{ unassignedFiltered().length }}
            </div>
            <div class="tasks-block__body" *ngIf="!collapsed().unassigned">
                <ng-container *ngIf="unassignedFiltered().length > 0; else noUnassignedMobile">
                    <app-task-card *ngFor="let t of unassignedFiltered()" [task]="t"
                        [isInProgress]="false"></app-task-card>
                </ng-container>
                <ng-template #noUnassignedMobile>
                    <p>Нет неназначенных задач.</p>
                </ng-template>
            </div>
        </div>

    </div>
</ng-container>